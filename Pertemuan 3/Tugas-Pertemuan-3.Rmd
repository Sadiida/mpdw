---
title: "Perbandingan Model Regresi dengan Lag"
author: "Qaulan Sadiida Putri Sumarna (G1401231001)"
date: "2025-09-15"
output:
  html_document:
    theme: yeti
    toc: true
    toc_float: true
  word_document: default
  pdf_document: default
---

# Library
```{r}
library(readxl)
library(dLagM)
library(dynlm)
library(MLmetrics)
library(lmtest)
library(car)
```
# Import Data
```{r}
data <-read_excel("~/IPB Kuliah/Semester 5/MPDW/Pertemuan 3/excel_NewDelhi_Air_quality.xls")
str(data)
data
```

```{r}
data$Yt <- as.numeric(data$Yt)
data$Xt <- as.numeric(data$Xt)
```

```{r}
data
```


# Pembagian Data
Di sini data dibagi menjadi 2 bagian yaitu data train dan data test
```{r}
#SPLIT DATA
train<-data[1:58,]
test<-data[59:72,]
```

```{r}
#data time series
train.ts<-ts(train)
test.ts<-ts(test)
data.ts<-ts(data)
```

# Model Koyck
$$
y_t=a(1-\lambda)+\beta_0X_t+\beta_1Z_t+\lambda Y_{t-1}+V_t
$$
dengan $$V_t=u_t-\lambda u_{t-1}$$

## Pemodelan
```{r}
#MODEL KOYCK
model.koyck <- koyckDlm(x = train$Xt, y = train$Yt)
summary(model.koyck)
```

```{r}
AIC(model.koyck)
BIC(model.koyck)
```

Dari hasil tersebut, didapat bahwa peubah $y_{t-1}$ memiliki nilai $P-Value<0.05$. Hal ini menunjukkan bahwa peubah $y_{t-1}$ berpengaruh signifikan terhadap $y$. Adapun model keseluruhannya adalah sebagai berikut:

$$
\hat{Y_t}=2.08.04+0.7826X_t+0.5726Y_{t-1}
$$
## Peramalan dan Akurasi
Berikut adalah ramalan untuk 14 periode kedepan menggunakan model koyck
```{r}
fore.koyck <- forecast(model = model.koyck, x=test$Xt, h=14)
fore.koyck
```
```{r}
mape.koyck <- MAPE(fore.koyck$forecasts, test$Yt)
mape.koyck #data test
```
Berdasarkan nilai MAPE yang kurang dari 10% artinya tingkat akurasi peramalan sangat baik.

```{r}
#akurasi data training
GoF(model.koyck)
```
## Kesimpulan
Model Koyck menunjukkan kinerja yang sangat baik dan andal untuk peramalan. Dengan nilai MAPE pada data test sebesar 8.8%, model ini terbukti memiliki kemampuan generalisasi yang kuat, di mana rata-rata kesalahan prediksi untuk data baru berada di bawah 10%. Meskipun nilai MAPE pada data train jauh lebih kecil (2.6%) yang mengindikasikan adanya sedikit gejala overfitting, akurasi yang tinggi pada data test menegaskan bahwa model ini tetap efektif dan dapat diandalkan untuk digunakan dalam peramalan di masa depan.

# Regression with Distribution Lag
## Pemodelan (Lag=2)
```{r}
model.dlm <- dlm(x = train$Xt,y = train$Yt , q = 1)
summary(model.dlm)
```
Hasil di atas menunjukkan bahwa tidak ada peubah yang berpengaruh signifikan pada taraf nyata 5%. Model keseluruhannya adalah sebagai berikut:
$$
\hat{Y_t}=21.626+0.38229X_t+82.539X_{t-1}
$$
```{r}
AIC(model.dlm)
BIC(model.dlm)
```
### Peramalan dan Akurasi
```{r}
fore.dlm <- forecast(model = model.dlm, x=test$Xt, h=14)
fore.dlm
```
```{r}
mape.dlm <- MAPE(fore.dlm$forecasts, test$Yt)
mape.dlm
```
```{r}
#akurasi data training
GoF(model.dlm)
```
## Pemodelan Lag Optimum
```{r}
#penentuan lag optimum 
finiteDLMauto(formula = Yt ~ Xt,
              data = data.frame(train), q.min = 1, q.max = 10,
              model.type = "dlm", error.type = "AIC", trace = TRUE)
```
```{r}
#model dlm dengan lag optimum
model.dlm2 <- dlm(x = train$Xt,y = train$Yt , q = 10)
summary(model.dlm2)
```
Dari hasil tersebut terdapat beberapa peubah yang berpengaruh signifikan terhadap taraf nyata 5% yaitu $x_t$. Adapun keseluruhan model yang terbentuk adalah:

$$
\hat{Y_t}=13.70+220.92X_t+...-13.43X_{t-10}
$$

```{r}
AIC(model.dlm2)
BIC(model.dlm2)
```
### Peramalan dan Akurasi
```{r}
#peramalan dan akurasi
fore.dlm2 <- forecast(model = model.dlm2, x=test$Xt, h=14)

#akurasi data test
mape.dlm2<- MAPE(fore.dlm2$forecasts, test$Yt)
mape.dlm2
```
```{r}
#akurasi data training
GoF(model.dlm2)
```
### Kesimpulan
Meskipun model ini menunjukkan kecocokan yang sangat tinggi dengan data latih, yang dibuktikan oleh nilai MAPE train sebesar 4%, kinerjanya pada data baru menunjukkan adanya masalah. Dengan nilai MAPE test sebesar 11%, rata-rata kesalahan prediksi pada data yang belum pernah dilihat adalah 11%, yang berada di ambang batas akurasi yang dapat diterima. Perbedaan yang cukup signifikan antara MAPE train dan test ini mengindikasikan adanya gejala overfitting, di mana model terlalu "menghafal" pola data latih sehingga kurang mampu menggeneralisasi dengan baik pada data baru. Oleh karena itu, walaupun model ini tampak sempurna pada data latih, keandalannya untuk peramalan di dunia nyata perlu diwaspadai karena akurasinya cenderung menurun.

# Model Autoregressive
## Pemodelan
```{r}
model.ardl <- ardlDlm(formula = Yt ~ Xt, data = train, p = 1, q = 1)
summary(model.ardl)
```
```{r}
AIC(model.ardl)
BIC(model.ardl)
```

Hasil di atas menunjukkan bahwa peubah $Y_{t-1}$ berpengaruh signifikan terhadap $y_t$. Model keseluruhannya adalah sebagai berikut:

$$
\hat{Y}=1.868+52.290X_t-24.094X_{t-1}+0,882Y_{t-1}
$$

### Peramalan dan Akurasi

```{r}
fore.ardl <- forecast(model = model.ardl, x=test$Xt, h=14)
fore.ardl
```

Data di atas merupakan hasil peramalan untuk 14 periode ke depan menggunakan Model Autoregressive dengan $p=1$ dan $q=1$.

```{r}
mape.ardl <- MAPE(fore.ardl$forecasts, test$Yt)
mape.ardl
```
```{r}
#akurasi data training
GoF(model.ardl)
```
### Kesimpulan
Kemampuan model untuk memprediksi data baru (MAPE test 2.6%) ternyata lebih akurat daripada kinerjanya saat mempelajari data latih (MAPE train 7%), yang menandakan model ini memiliki kemampuan generalisasi sangat kuat dan sama sekali tidak overfitting.

## Pemodelan Lag Optimum
```{r}
#penentuan lag optimum
model.ardl.opt <- ardlBoundOrders(data = data.frame(data), ic = "AIC", 
                                  formula = Yt ~ Xt )
model.ardl.opt
```

```{r}
min_p=c()
for(i in 1:6){
  min_p[i]=min(model.ardl.opt$Stat.table[[i]])
}
q_opt=which(min_p==min(min_p, na.rm = TRUE))
p_opt=which(model.ardl.opt$Stat.table[[q_opt]] == 
              min(model.ardl.opt$Stat.table[[q_opt]], na.rm = TRUE))
data.frame("q_optimum" = q_opt, "p_optimum" = p_opt, 
           "AIC"=model.ardl.opt$min.Stat)
```
Dari tabel di atas, dapat terlihat bahwa nilai AIC terendah didapat ketika $p=14$ dan $q=6$, yaitu sebesar `-20,56587`. Artinya, model autoregressive optimum didapat ketika $p=14$ dan $q=6$.

Selanjutnya dapat dilakukan pemodelan dengan nilai $p$ dan $q$ optimum seperti inisialisasi di langkah sebelumnya.


```{r}
model.ardl_opt <- ardlDlm(formula = Yt ~ Xt, 
                         data = train,p = 14 , q = 6)
summary(model.ardl_opt)
```
```{r}
AIC(model.ardl_opt)
BIC(model.ardl_opt)
```
### Peramalan dan Akurasi

```{r}
fore.ardl_opt <- forecast(model = model.ardl_opt, x=test$Xt, h=14)
fore.ardl_opt
```
```{r}
mape.ardl_opt <- MAPE(fore.ardl_opt$forecasts, test$Yt)
mape.ardl_opt
```
```{r}
#akurasi data training
GoF(model.ardl_opt)
```
### Kesimpulan

Karena nilai MAPE untuk data train dan data test sama-sama dibawah 10% maka disimpulkan bahwa model dapat memelajari data dengan baik.

# Perbandingan Model dengan MAPE
```{r}
akurasi <- matrix(c(mape.koyck, mape.dlm, mape.dlm2, mape.ardl, mape.ardl_opt))
row.names(akurasi)<- c("Koyck","DLM 1","DLM 2","Autoregressive", "Autoregressive 2")
colnames(akurasi) <- c("MAPE")
akurasi
```
Berdasarkan nilai MAPE, model paling optimum didapat pada Model Autoregressive 2 yaitu yang menggunakan lag optimum karena memiliki nilai MAPE yang terkecil.


# Plot

```{r}
par(mfrow=c(1,1))

# Plot data aktual TANPA ylim agar R menyesuaikan otomatis
plot(test$Xt, test$Yt, type="b", col="black",
     xlab="Waktu", ylab="Nilai", main="Perbandingan Model Peramalan") # Tambah label agar rapi

# Tambahkan garis ramalan dari masing-masing model
lines(test$Xt, fore.koyck$forecasts, col="red")
lines(test$Xt, fore.dlm$forecasts, col="blue")
lines(test$Xt, fore.dlm2$forecasts, col="orange")
lines(test$Xt, fore.ardl$forecasts, col="green")
lines(test$Xt, fore.ardl_opt$forecasts, col="pink")

# Legenda yang sudah diperbaiki (5 model, 5 warna)
legend("topleft",
       c("Aktual", "Koyck", "DLM 1", "DLM 2", "ARDL", "ARDL Optimal"), # Sesuaikan nama jika perlu
       lty=1, col=c("black", "red", "blue", "orange", "green", "pink"), 
       cex=0.8)
```

